<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Club Portal (MVP)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 24px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; width: 360px; }
    .item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; }
    .item:last-child { border-bottom: none; }
    .muted { color: #666; font-size: 12px; }
    .title { font-weight: 600; }
    button { padding: 6px 10px; }
    input { padding: 6px; width: 100%; box-sizing: border-box; margin: 6px 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
  </style>

  <link rel="stylesheet" href="theme.css">
</head>
<body>
  <a class="link-back" href="home.html">Back to Home</a>
  <!-- 调试版入口页面：用于后端接口联调与数据查看 -->
  <h1>Club Enrolment Portal (MVP)</h1>

  <div class="row">
    <!-- 俱乐部列表：点击条目会加载对应的可预约时段 -->
    <div class="card">
      <div class="title">Clubs</div>
      <div class="muted">Click a club to load timeslots</div>
      <div id="clubs"></div>
    </div>

    <!-- 时段列表与预约：可手动输入用户与时间范围做测试 -->
    <div class="card">
      <div class="title">Timeslots</div>
      <div class="muted">Range (ISO):</div>
      <input id="userId" placeholder="userId" value="1" />
      <input id="userMembershipId" placeholder="userMembershipId (optional)" value="2" />
      <input id="from" placeholder="from, e.g. 2026-01-16T00:00:00" value="2026-01-16T00:00:00" />
      <input id="to" placeholder="to, e.g. 2026-01-17T00:00:00" value="2026-01-17T00:00:00" />
      <button id="reload">Reload timeslots</button>
      <div class="muted" id="lastUpdated"></div>
      <div class="muted" id="selectedClub"></div>
      <div class="muted" id="bookResult"></div>
      <div id="timeslots"></div>
    </div>
  </div>

  <!-- 我的预约记录：用于验证预约/取消接口是否生效 -->
  <div class="card" style="margin-top:24px; width: 760px;">
    <div class="title">My Bookings (userId=1)</div>
    <button id="loadBookings">Reload bookings</button>
    <div id="bookings"></div>
  </div>

  <!-- 调试输出：展示接口响应或错误信息 -->
  <h3>Debug</h3>
  <pre class="mono" id="debug"></pre>

  <footer class="site-footer">
    <div class="site-footer__wrap">
      <span class="site-footer__text">&copy; 2026 Sports Club System</span>
      <div class="site-footer__actions">
        <button class="site-footer__btn info-trigger" type="button" data-info="privacy">Privacy</button>
        <button class="site-footer__btn info-trigger" type="button" data-info="terms">Terms</button>
        <button class="site-footer__btn info-trigger" type="button" data-info="help">Help</button>
      </div>
    </div>
  </footer>

<!-- 调试脚本：演示接口调用与渲染 -->
<script>
  // 接口基础地址（后端服务）
  const API_BASE = "http://13.40.74.21:8080";

  // 当前选中的俱乐部 ID
  let currentClubId = null;

  // 简单调试输出，统一写入页面底部区域
  function debug(msg) {
    const el = document.getElementById("debug");
    el.textContent = (typeof msg === "string") ? msg : JSON.stringify(msg, null, 2);
  }

  // GET 请求封装：返回 JSON 或文本
  async function apiGet(path) {
    const res = await fetch(`${API_BASE}${path}`, { credentials: "include" });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = text; }
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}: ${typeof data === "string" ? data : (data.message || text)}`);
    return data;
  }

  // POST 请求封装：带 JSON body
  async function apiPost(path, bodyObj) {
    const res = await fetch(`${API_BASE}${path}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(bodyObj)
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = text; }
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}: ${typeof data === "string" ? data : (data.message || text)}`);
    return data;
  }

  // 渲染俱乐部列表，并绑定点击事件
  function renderClubs(clubs) {
    const box = document.getElementById("clubs");
    box.innerHTML = "";
    if (!clubs.length) {
      box.innerHTML = '<div class="muted">No clubs found.</div>';
      return;
    }
    clubs.forEach(c => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<div><span class="title">${c.clubName}</span></div><div class="muted">${c.sportType || ""}</div>`;
      div.onclick = () => {
        currentClubId = c.clubId;
        document.getElementById("selectedClub").textContent = `Selected clubId = ${currentClubId}`;
        loadTimeslots();
      };
      box.appendChild(div);
    });
  }

  // 渲染时段列表，并提供“Book”按钮
  function renderTimeslots(list) {
    const box = document.getElementById("timeslots");
    box.innerHTML = "";
    if (!list.length) {
      box.innerHTML = '<div class="muted">No timeslots in this range.</div>';
      return;
    }

    list.forEach(t => {
      const div = document.createElement("div");
      div.className = "item";

      const btn = document.createElement("button");
      btn.textContent = "Book";
      btn.onclick = async (e) => {
        e.stopPropagation();

        const userId = Number(document.getElementById("userId").value);
        const rawUm = document.getElementById("userMembershipId").value.trim();
        const userMembershipId = rawUm ? Number(rawUm) : null;

        const body = { userId, timeslotId: t.timeslotId };
        if (userMembershipId !== null) body.userMembershipId = userMembershipId;

        try {
          const result = await apiPost("/api/bookings", body);
          document.getElementById("bookResult").textContent =
            `Booked: bookingId=${result.bookingId}, priceToPay=${result.priceToPay}, status=${result.status}`;
          debug(result);
          await loadBookings();
        } catch (err) {
          document.getElementById("bookResult").textContent = `Book failed: ${String(err)}`;
          debug(String(err));
        }
      };

      div.innerHTML = `
        <div class="title">timeslotId=${t.timeslotId} ${t.membersOnly ? "(Members only)" : ""}</div>
        <div class="muted">${t.startTime} -> ${t.endTime}</div>
        <div class="muted">capacity=${t.capacity}, allowBooking=${t.allowBooking}</div>
        <div class="muted">price=${t.price}, membersPrice=${t.membersPrice}</div>
      `;
      div.appendChild(btn);
      box.appendChild(div);
    });
  }

  // 加载俱乐部列表
  async function loadClubs() {
    try {
      const clubs = await apiGet("/api/clubs");
      renderClubs(clubs);
      debug({ ok: true, clubsCount: clubs.length });
    } catch (e) {
      debug(String(e));
    }
  }

  // 加载指定俱乐部在某个时间范围内的时段
  async function loadTimeslots() {
    if (!currentClubId) {
      debug("Select a club first.");
      return;
    }
    const from = encodeURIComponent(document.getElementById("from").value.trim());
    const to = encodeURIComponent(document.getElementById("to").value.trim());
    debug({ loading: true, clubId: currentClubId, from: decodeURIComponent(from), to: decodeURIComponent(to) });
    try {
      const list = await apiGet(`/api/clubs/${currentClubId}/timeslots?from=${from}&to=${to}`);
      renderTimeslots(list);
      document.getElementById("lastUpdated").textContent = `Last loaded: ${new Date().toISOString()}`;
      debug({ ok: true, clubId: currentClubId, timeslotsCount: list.length });
    } catch (e) {
      debug(String(e));
    }
  }

  // 渲染我的预约记录（支持取消）
  function renderBookings(list) {
    const box = document.getElementById("bookings");
    box.innerHTML = "";
    if (!list.length) {
      box.innerHTML = '<div class="muted">No bookings.</div>';
      return;
    }

    list.forEach(b => {
      const div = document.createElement("div");
      div.className = "item";

      const isCancelled = (b.status === 2);
      const btn = document.createElement("button");
      btn.textContent = isCancelled ? "Cancelled" : "Cancel";
      btn.disabled = isCancelled;

      btn.onclick = async () => {
        try {
          const result = await apiPost(`/api/bookings/${b.bookingId}/cancel`, {});
          debug(result);
          await loadBookings();
        } catch (err) {
          debug(String(err));
        }
      };

      div.innerHTML = `
        <div class="title">bookingId=${b.bookingId} (status=${b.status})</div>
        <div class="muted">timeslotId=${b.timeslotId}, priceToPay=${b.priceToPay}, covered=${b.isCoveredByMembership}</div>
        <div class="muted">cancelTime=${b.cancelTime || "-"}</div>
      `;

      div.appendChild(btn);
      box.appendChild(div);
    });
  }

  // 加载我的预约记录
  async function loadBookings() {
    try {
      const userId = Number(document.getElementById("userId").value);
      const list = await apiGet(`/api/users/${userId}/bookings`);
      renderBookings(list);
      debug({ ok: true, bookingsCount: list.length });
    } catch (e) {
      debug(String(e));
    }
  }

  // 事件绑定：刷新时段与预约列表
  document.getElementById("reload").onclick = loadTimeslots;
  document.getElementById("loadBookings").onclick = loadBookings;

  // 初始加载：拉取俱乐部与预约记录
  loadClubs();
  loadBookings();
</script>

  <script src="auth-modal.js" defer></script>
</body>
</html>
