<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Venue overview</title>
  <link rel="stylesheet" href="theme.css">
  <style>
    body {
      margin: 0;
      background: #f7f8fb;
      color: #0f172a;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
    }
    .wrap {
      max-width: 980px;
      margin: 40px auto 80px;
      padding: 24px;
    }
    .hero {
      background: #ffffff;
      border-radius: 22px;
      padding: 24px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      display: grid;
      gap: 8px;
      position: relative;
    }
    .hero h1 {
      margin: 0;
      font-size: 28px;
    }
    .hero p {
      margin: 0;
      color: #5b6476;
    }
    .back-btn {
      position: absolute;
      top: 18px;
      right: 18px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #ffffff;
      color: #111111;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
    }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: #0066cc;
      text-decoration: none;
      border: none;
      background: none;
      cursor: pointer;
      padding: 8px 0;
    }
    .header-wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 0 24px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
    }
    .header-wrap h2 {
      justify-self: center;
    }
    .panel {
      margin-top: 24px;
      background: #ffffff;
      border-radius: 22px;
      padding: 24px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      display: grid;
      gap: 16px;
    }
    .panel-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .panel-header h2 {
      margin: 0 0 6px;
      font-size: 20px;
    }
    .panel-header p {
      margin: 0;
      color: #6b7280;
      font-size: 13px;
    }
    .filter-toggle {
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: linear-gradient(180deg, #ffffff, #f5f7ff);
      color: #15171a;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    .filter-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
    }
    .filter-toggle.active {
      background: #111111;
      color: #ffffff;
      border-color: #111111;
    }
    .filter-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      margin-left: 6px;
      border-radius: 999px;
      background: rgba(17, 17, 17, 0.1);
      font-size: 11px;
      padding: 0 6px;
    }
    .filter-surface {
      display: none;
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background: #ffffff;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    }
    .filter-surface.open {
      display: block;
    }
    .filter-surface__body {
      display: none;
      gap: 10px;
      margin-top: 0;
    }
    .filter-surface.open .filter-surface__body {
      display: grid;
    }
    .filter-panel {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      width: 100%;
    }
    .filter-chip {
      border: 1px solid var(--line);
      background: var(--chip);
      color: #15171a;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    .filter-chip:hover {
      transform: translateY(-1px);
      background: #ffffff;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    }
    .filter-chip.active {
      background: #111111;
      color: #ffffff;
      border-color: #111111;
    }
    .summary-list {
      display: grid;
      gap: 18px;
    }
    .summary-group {
      display: grid;
      gap: 10px;
    }
    .summary-title {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #0f172a;
    }
    .panel-empty {
      color: #6b7280;
      font-size: 13px;
      border: 1px dashed rgba(148, 163, 184, 0.5);
      border-radius: 14px;
      padding: 16px;
      background: rgba(248, 250, 252, 0.9);
    }
    .court-list {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .court-card {
      position: relative;
      border-radius: 16px;
      padding: 14px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: #ffffff;
      display: grid;
      gap: 10px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .court-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
    }
    .court-card:focus-visible {
      outline: 2px solid rgba(37, 99, 235, 0.4);
      outline-offset: 2px;
    }
    .court-card__row {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) auto auto;
      align-items: center;
      gap: 10px;
    }
    .court-meta {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      grid-column: 2;
    }
    .court-badge {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(37, 99, 235, 0.12);
      color: #1d4ed8;
      font-weight: 600;
      border: 1px solid rgba(37, 99, 235, 0.2);
    }
    .court-name {
      width: 100%;
      height: 36px;
      border-radius: 10px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      padding: 0 10px;
      font-size: 13px;
      flex: 1 1 160px;
      max-width: 200px;
      min-width: 120px;
      justify-self: start;
    }
    .court-confirm {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: #111111;
      color: #ffffff;
      white-space: nowrap;
      grid-column: 3;
      justify-self: start;
    }
    .court-confirm:hover {
      background: #000000;
    }
    .court-manage {
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #111111;
      color: #ffffff;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      grid-column: 3;
      justify-self: start;
    }
    .court-manage:hover {
      background: #000000;
    }
    .court-delete {
      border: 1px solid rgba(220, 38, 38, 0.3);
      background: #fff5f5;
      color: #dc2626;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      grid-column: 4;
      justify-self: start;
    }
    .court-delete:hover {
      background: #fee2e2;
    }
    .slot-list {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    @media (max-width: 720px) {
      .slot-list {
        grid-template-columns: 1fr;
      }
    }
    .slot-card {
      position: relative;
      border-radius: 16px;
      padding: 14px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: #ffffff;
      display: grid;
      gap: 8px;
    }
    .slot-delete {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(220, 38, 38, 0.3);
      background: #fff5f5;
      color: #dc2626;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
    }
    .slot-delete:hover {
      background: #fee2e2;
    }
    .slot-skip {
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #ffffff;
      color: #111111;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .slot-skip:hover {
      background: #f3f4f6;
    }
    .modal-confirm {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: #111111;
      color: #ffffff;
    }
    .modal-confirm:hover {
      background: #000000;
    }
    .modal-step {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      color: #1d4ed8;
      background: rgba(37, 99, 235, 0.12);
      border: 1px solid rgba(37, 99, 235, 0.2);
      width: fit-content;
    }
    .modal-name-step {
      display: grid;
      gap: 10px;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: #ffffff;
    }
    .modal-name-input {
      width: 100%;
      height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      padding: 0 12px;
      font-size: 14px;
    }
    .modal-name-input.is-invalid {
      border-color: rgba(220, 38, 38, 0.6);
      background: #fff5f5;
    }
    .modal-name-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .modal-continue {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: #111111;
      color: #ffffff;
    }
    .modal-continue:hover {
      background: #000000;
    }
    .modal-step-hint {
      font-size: 12px;
      color: #6b7280;
      margin: 0;
    }
    .slot-badge {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(37, 99, 235, 0.12);
      color: #1d4ed8;
      font-weight: 600;
      border: 1px solid rgba(37, 99, 235, 0.2);
    }
    .slot-label {
      font-size: 12px;
      font-weight: 600;
      color: #0f172a;
    }
    .slot-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .slot-input {
      width: 100%;
      height: 36px;
      border-radius: 10px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      padding: 0 10px;
      font-size: 13px;
    }
    .slot-input[type="time"] {
      cursor: pointer;
    }
    .slot-sep {
      font-size: 12px;
      color: #6b7280;
      white-space: nowrap;
    }
    .slot-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 2px;
    }
    .slot-status {
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.06);
    }
    .slot-confirm {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: #111111;
      color: #ffffff;
    }
    .slot-confirm:hover {
      background: #000000;
    }
    .summary-card input:disabled {
      background: rgba(248, 250, 252, 0.9);
      color: #0f172a;
      opacity: 1;
    }
    .slot-card.is-confirmed {
      border-color: rgba(34, 197, 94, 0.3);
      box-shadow: 0 12px 24px rgba(34, 197, 94, 0.12);
    }
    .slot-card.is-confirmed .slot-status {
      background: rgba(34, 197, 94, 0.12);
      color: #15803d;
    }
    .slot-card.is-warning {
      border-color: rgba(245, 158, 11, 0.4);
      box-shadow: 0 12px 24px rgba(245, 158, 11, 0.15);
    }
    .slot-card.is-warning .slot-status {
      background: rgba(245, 158, 11, 0.16);
      color: #b45309;
    }
    .add-slot {
      justify-self: start;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #ffffff;
      cursor: pointer;
    }
    .slot-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: rgba(10, 12, 16, 0.45);
      z-index: 4000;
    }
    .slot-modal.open {
      display: flex;
    }
    .slot-modal__card {
      width: min(860px, 92vw);
      max-height: 86vh;
      overflow: auto;
      background: #ffffff;
      border-radius: 22px;
      padding: 24px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 30px 70px rgba(15, 23, 42, 0.25);
      position: relative;
      display: grid;
      gap: 16px;
    }
    .slot-modal__close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #ffffff;
      cursor: pointer;
      font-size: 16px;
    }
    .slot-modal__header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      padding-right: 48px;
    }
  </style>
</head>
<body>
  <header style="position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #e5e7eb; background: white; padding: 12px 0;">
    <div class="header-wrap">
      <button class="back-link" onclick="window.location.href = 'club home.html'" type="button" aria-label="Back">← Back</button>
      <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Venue overview</h2>
    </div>
  </header>
  <main class="wrap">
    <section class="panel">
      <div class="panel-header">
        <div>
          <h2>Manage courts</h2>
          <p>Create courts and open each one to edit booking slots.</p>
        </div>
        <button id="addCourt" class="add-slot" type="button">Add court</button>
      </div>
      <div id="courtList" class="court-list"></div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div>
          <h2>Booking slots</h2>
          <p>Select a court above to manage its slots.</p>
        </div>
        <button class="filter-toggle" type="button" id="slotFilterToggle" aria-expanded="false" aria-controls="slotFilterSurface">
          Filter <span class="filter-count" id="slotFilterCount" style="display:none">0</span>
        </button>
      </div>
      <div class="filter-surface" id="slotFilterSurface">
        <div class="filter-surface__body">
          <div class="filter-panel" id="slotFilterPanel" aria-label="Filter slots by court"></div>
        </div>
      </div>
      <div id="bookingSummary" class="summary-list"></div>
    </section>
  </main>

  <div id="slotModal" class="slot-modal" aria-hidden="true">
    <div class="slot-modal__card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="slot-modal__header">
        <div>
          <span id="modalStep" class="modal-step">Step 1 of 2</span>
          <h2 id="modalTitle">Booking slots</h2>
          <p id="modalSubtitle">Adjust time and positions for this court (placeholder).</p>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="modalSkip" class="slot-skip" type="button">Skip for now</button>
          <button id="modalConfirmSlots" class="modal-confirm" type="button">Confirm</button>
          <button id="modalAddSlot" class="add-slot" type="button">Add slot</button>
        </div>
      </div>
      <div id="modalNameStep" class="modal-name-step">
        <p class="modal-step-hint">Name your court to continue.</p>
        <input id="modalCourtName" class="modal-name-input" type="text" placeholder="Court name">
        <div class="modal-name-actions">
          <button id="modalContinue" class="modal-continue" type="button">Continue</button>
        </div>
      </div>
      <div id="modalSlotsStep">
        <div id="modalSlotList" class="slot-list"></div>
      </div>
    </div>
  </div>

  <script>
    const courtList = document.getElementById('courtList');
    const addCourtBtn = document.getElementById('addCourt');
    const slotModal = document.getElementById('slotModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalSubtitle = document.getElementById('modalSubtitle');
    const modalStep = document.getElementById('modalStep');
    const modalNameStep = document.getElementById('modalNameStep');
    const modalSlotsStep = document.getElementById('modalSlotsStep');
    const modalCourtName = document.getElementById('modalCourtName');
    const modalContinue = document.getElementById('modalContinue');
    const modalSlotList = document.getElementById('modalSlotList');
    const modalAddSlot = document.getElementById('modalAddSlot');
    const modalSkip = document.getElementById('modalSkip');
    const modalConfirmSlots = document.getElementById('modalConfirmSlots');
    const modalClose = document.getElementById('modalClose');
    const bookingSummary = document.getElementById('bookingSummary');
    const slotFilterToggle = document.getElementById('slotFilterToggle');
    const slotFilterSurface = document.getElementById('slotFilterSurface');
    const slotFilterPanel = document.getElementById('slotFilterPanel');
    const slotFilterCount = document.getElementById('slotFilterCount');

    // Placeholder API layer (swap endpoints when backend is ready).
    const DB_API_BASE = '';
    const COURTS_ENDPOINT = '/api/club/courts';
    const SLOTS_ENDPOINT = '/api/club/slots';

    const authFetch = (url, options = {}) => {
      const token = localStorage.getItem('token');
      const headers = { ...(options.headers || {}) };
      if (token) headers.Authorization = `Bearer ${token}`;
      return fetch(url, {
        ...options,
        credentials: options.credentials ?? 'include',
        headers
      });
    };

    const apiRequest = async (path, options = {}) => {
      if (!DB_API_BASE) return null;
      try {
        const response = await authFetch(`${DB_API_BASE}${path}`, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...(options.headers || {})
          }
        });
        if (!response.ok) throw new Error(`API ${response.status}`);
        return await response.json();
      } catch (error) {
        console.warn('[venue overview] API error', error);
        return null;
      }
    };

    const fetchCourtsFromApi = async () => apiRequest(COURTS_ENDPOINT);
    const saveCourtToApi = async (court) => apiRequest(COURTS_ENDPOINT, {
      method: 'POST',
      body: JSON.stringify(court),
    });
    const saveSlotToApi = async (courtId, slot) => apiRequest(SLOTS_ENDPOINT, {
      method: 'POST',
      body: JSON.stringify({ courtId, ...slot }),
    });

    let courts = [];
    let courtCount = 0;
    let lastCreatedCourtId = null;
    let modalStepState = 'name';
    let activeCourtId = null;
    const selectedCourtFilters = [];

    const courtKey = (court) => `court-${court.id}`;

    const createSlot = (start = '08:00', end = '09:00', positions = 1) => ({
      id: null,
      start,
      end,
      positions,
      confirmed: false,
      overlapConfirmed: false,
      isNew: true,
    });

    const timeToMinutes = (value) => {
      if (!value) return null;
      const [hours, minutes] = value.split(':').map((part) => Number(part));
      if (Number.isNaN(hours) || Number.isNaN(minutes)) return null;
      return hours * 60 + minutes;
    };

    const getOverlapSlot = (slot, court) => {
      if (!court) return null;
      const start = timeToMinutes(slot.start);
      const end = timeToMinutes(slot.end);
      if (start === null || end === null || start >= end) return null;
      return court.slots.find((other) => {
        if (other === slot) return false;
        const otherStart = timeToMinutes(other.start);
        const otherEnd = timeToMinutes(other.end);
        if (otherStart === null || otherEnd === null || otherStart >= otherEnd) return false;
        return start < otherEnd && end > otherStart;
      }) || null;
    };

    const isValidRange = (slot) => {
      const start = timeToMinutes(slot.start);
      const end = timeToMinutes(slot.end);
      return start !== null && end !== null && end > start;
    };

    const createCourt = () => {
      courtCount += 1;
      return {
        id: courtCount,
        name: '',
        nameConfirmed: false,
        slots: [],
      };
    };

    const normalizeCourts = (data) => (
      data.map((court, index) => ({
        id: Number(court.id) || index + 1,
        name: court.name || `Court ${index + 1}`,
        nameConfirmed: Boolean(court.nameConfirmed),
        slots: Array.isArray(court.slots)
          ? court.slots.map((slot, slotIndex) => ({
            id: slot.id ?? null,
            start: slot.start || '08:00',
            end: slot.end || '09:00',
            positions: Number(slot.positions) || 1,
            confirmed: Boolean(slot.confirmed),
            overlapConfirmed: false,
            isNew: false,
          }))
          : [],
      }))
    );

    const getActiveCourt = () => courts.find((court) => court.id === activeCourtId);

    const setModalStep = (step) => {
      modalStepState = step;
      if (modalNameStep) {
        modalNameStep.style.display = step === 'name' ? 'grid' : 'none';
      }
      if (modalSlotsStep) {
        modalSlotsStep.style.display = step === 'slots' ? 'block' : 'none';
      }
      if (modalAddSlot) {
        modalAddSlot.style.display = step === 'slots' ? 'inline-flex' : 'none';
      }
      if (modalSkip) {
        modalSkip.style.display = step === 'slots' ? 'inline-flex' : 'none';
      }
      if (modalConfirmSlots) {
        modalConfirmSlots.style.display = 'none';
      }
      if (modalStep) {
        modalStep.textContent = step === 'name' ? 'Step 1 of 2' : 'Step 2 of 2';
      }
      if (modalTitle) {
        modalTitle.textContent = step === 'name' ? 'Name this court' : 'Booking slots';
      }
      if (modalSubtitle) {
        modalSubtitle.textContent = step === 'name'
          ? 'Give the court a clear name before setting slots.'
          : 'Adjust time and positions for this court (placeholder).';
      }
    };

    const openModal = (courtId) => {
      const court = courts.find((item) => item.id === courtId);
      if (!court || !slotModal) return;
      activeCourtId = courtId;
      const name = court.name && court.name.trim() ? court.name.trim() : '';
      if (modalCourtName) {
        modalCourtName.value = name;
        modalCourtName.classList.remove('is-invalid');
      }
      setModalStep(court.nameConfirmed ? 'slots' : 'name');
      if (court.nameConfirmed && modalTitle) {
        const displayName = name || `Court ${court.id}`;
        modalTitle.textContent = `Booking slots - ${displayName}`;
      }
      slotModal.classList.add('open');
      slotModal.setAttribute('aria-hidden', 'false');
      if (modalStepState === 'slots') {
        renderSlots();
      }
      if (modalStepState === 'name' && modalCourtName) {
        setTimeout(() => {
          modalCourtName.focus();
          modalCourtName.select();
        }, 0);
      }
    };

    const closeModal = () => {
      if (!slotModal) return;
      const court = getActiveCourt();
      if (court) {
        const nameEmpty = !court.name || !court.name.trim();
        const hasSlots = Array.isArray(court.slots) && court.slots.length > 0;
        if (!court.nameConfirmed && nameEmpty && !hasSlots) {
          courts = courts.filter((item) => item.id !== court.id);
          const key = courtKey(court);
          const filterIndex = selectedCourtFilters.indexOf(key);
          if (filterIndex > -1) {
            selectedCourtFilters.splice(filterIndex, 1);
          }
          renderCourts();
          renderSlotFilterChips();
          renderSummary();
        }
      }
      slotModal.classList.remove('open');
      slotModal.setAttribute('aria-hidden', 'true');
      activeCourtId = null;
    };

    const confirmCourtName = () => {
      const court = getActiveCourt();
      if (!court || !modalCourtName) return;
      const name = modalCourtName.value.trim();
      if (!name) {
        modalCourtName.classList.add('is-invalid');
        modalCourtName.focus();
        return;
      }
      modalCourtName.classList.remove('is-invalid');
      court.name = name;
      court.nameConfirmed = true;
      lastCreatedCourtId = null;
      renderCourts();
      renderSlotFilterChips();
      renderSummary();
      void saveCourtToApi(court);
      setModalStep('slots');
      if (modalTitle) {
        modalTitle.textContent = `Booking slots - ${name}`;
      }
      renderSlots();
    };

    const renderCourts = () => {
      if (!courtList) return;
      courtList.innerHTML = '';

      if (!courts.length) {
        const empty = document.createElement('div');
        empty.className = 'panel-empty';
        empty.textContent = 'Add a court to start managing booking slots.';
        courtList.appendChild(empty);
        return;
      }

      courts.forEach((court, index) => {
        const card = document.createElement('div');
        card.className = 'court-card';
        card.tabIndex = 0;
        card.setAttribute('role', 'button');

        const rowTop = document.createElement('div');
        rowTop.className = 'court-card__row';

        const badge = document.createElement('div');
        badge.className = 'court-badge';
        badge.textContent = String(index + 1);

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.className = 'court-name';
        nameInput.value = court.name;
        nameInput.placeholder = `Court ${court.id}`;
        if (court.id === lastCreatedCourtId) {
          setTimeout(() => {
            nameInput.focus();
            nameInput.select();
          }, 0);
        }
        nameInput.addEventListener('input', (event) => {
          court.name = event.target.value;
          if (activeCourtId === court.id && modalTitle) {
            const displayName = court.name && court.name.trim() ? court.name.trim() : `Court ${court.id}`;
            modalTitle.textContent = `Booking slots - ${displayName}`;
          }
          renderSlotFilterChips();
          renderSummary();
        });
        nameInput.addEventListener('click', (event) => event.stopPropagation());
        nameInput.addEventListener('keydown', (event) => event.stopPropagation());

        const confirmBtn = document.createElement('button');
        confirmBtn.type = 'button';
        confirmBtn.className = 'court-confirm';

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'court-delete';
        deleteBtn.textContent = 'Delete';

        const setNameConfirmed = (confirmed) => {
          court.nameConfirmed = confirmed;
          nameInput.disabled = confirmed;
          confirmBtn.textContent = confirmed ? 'Edit' : 'Confirm';
          renderSlotFilterChips();
          renderSummary();
          if (confirmed) {
            void saveCourtToApi(court);
          }
        };

        confirmBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          setNameConfirmed(!court.nameConfirmed);
        });

        deleteBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          courts = courts.filter((item) => item.id !== court.id);
          const key = courtKey(court);
          const filterIndex = selectedCourtFilters.indexOf(key);
          if (filterIndex > -1) {
            selectedCourtFilters.splice(filterIndex, 1);
          }
          if (activeCourtId === court.id) {
            closeModal();
          }
          renderCourts();
          renderSlotFilterChips();
          renderSummary();
        });

        rowTop.appendChild(badge);
        rowTop.appendChild(nameInput);
        rowTop.appendChild(confirmBtn);
        rowTop.appendChild(deleteBtn);

        const rowBottom = document.createElement('div');
        rowBottom.className = 'court-card__row';

        const meta = document.createElement('div');
        meta.className = 'court-meta';
        const slotCount = court.slots.length;
        meta.textContent = `${slotCount} slot${slotCount === 1 ? '' : 's'}`;

        const manageBtn = document.createElement('button');
        manageBtn.type = 'button';
        manageBtn.className = 'court-manage';
        manageBtn.textContent = 'Manage slots';
        manageBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          openModal(court.id);
        });

        rowBottom.appendChild(meta);
        rowBottom.appendChild(manageBtn);

        card.appendChild(rowTop);
        card.appendChild(rowBottom);

        card.addEventListener('click', () => openModal(court.id));
        card.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            openModal(court.id);
          }
        });

        courtList.appendChild(card);

        setNameConfirmed(Boolean(court.nameConfirmed));
      });
    };

    const updateSlotFilterUI = () => {
      if (slotFilterPanel) {
        slotFilterPanel.querySelectorAll('.filter-chip').forEach((btn) => {
          btn.classList.toggle('active', selectedCourtFilters.includes(btn.dataset.key));
        });
      }
      if (slotFilterToggle) {
        slotFilterToggle.classList.toggle('active', selectedCourtFilters.length > 0);
      }
      if (slotFilterCount) {
        if (selectedCourtFilters.length) {
          slotFilterCount.style.display = 'inline-flex';
          slotFilterCount.textContent = String(selectedCourtFilters.length);
        } else {
          slotFilterCount.style.display = 'none';
        }
      }
    };

    const renderSlotFilterChips = () => {
      if (!slotFilterPanel) return;
      slotFilterPanel.innerHTML = '';

      const chips = courts.map((court) => ({
        key: courtKey(court),
        label: court.name && court.name.trim() ? court.name.trim() : `Court ${court.id}`,
      }));

      slotFilterPanel.innerHTML = chips.map((chip) => (
        `<button class="filter-chip" type="button" data-key="${chip.key}"># ${chip.label}</button>`
      )).join('');

      slotFilterPanel.querySelectorAll('.filter-chip').forEach((btn) => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.key;
          const idx = selectedCourtFilters.indexOf(key);
          if (idx > -1) {
            selectedCourtFilters.splice(idx, 1);
          } else {
            selectedCourtFilters.push(key);
          }
          updateSlotFilterUI();
          renderSummary();
        });
      });

      updateSlotFilterUI();
    };

    const renderSummary = () => {
      if (!bookingSummary) return;
      bookingSummary.innerHTML = '';

      const filteredCourts = selectedCourtFilters.length
        ? courts.filter((court) => selectedCourtFilters.includes(courtKey(court)))
        : courts;
      const hasConfirmedSlots = filteredCourts.some((court) => court.slots.some((slot) => slot.confirmed));
      if (!hasConfirmedSlots) {
        const empty = document.createElement('div');
        empty.className = 'panel-empty';
        empty.textContent = selectedCourtFilters.length
          ? 'No confirmed slots match the selected courts.'
          : 'Confirm a slot to show it here.';
        bookingSummary.appendChild(empty);
        return;
      }

      filteredCourts.forEach((court) => {
        const confirmedSlots = court.slots.filter((slot) => slot.confirmed);
        if (!confirmedSlots.length) return;

        const group = document.createElement('div');
        group.className = 'summary-group';

        const title = document.createElement('div');
        title.className = 'summary-title';
        const name = court.name && court.name.trim() ? court.name.trim() : `Court ${court.id}`;
        title.textContent = `Court: ${name}`;

        const list = document.createElement('div');
        list.className = 'slot-list';

        confirmedSlots.forEach((slot, index) => {
          const card = document.createElement('div');
          card.className = 'slot-card summary-card';
          card.classList.toggle('is-confirmed', Boolean(slot.confirmed));

          const badge = document.createElement('div');
          badge.className = 'slot-badge';
          badge.textContent = String(index + 1);

          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'slot-delete';
          deleteBtn.setAttribute('aria-label', 'Remove slot');
          deleteBtn.textContent = '×';
          deleteBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            const slotIndex = court.slots.indexOf(slot);
            if (slotIndex > -1) {
              court.slots.splice(slotIndex, 1);
            }
            renderSummary();
            renderSlots();
            renderCourts();
            renderSlotFilterChips();
          });

          const timeLabel = document.createElement('div');
          timeLabel.className = 'slot-label';
          timeLabel.textContent = 'Time';

          const timeRow = document.createElement('div');
          timeRow.className = 'slot-row';

          const startTime = document.createElement('input');
          startTime.type = 'time';
          startTime.className = 'slot-input';
          startTime.value = slot.start;
          startTime.disabled = true;

          const sep = document.createElement('span');
          sep.className = 'slot-sep';
          sep.textContent = 'to';

          const endTime = document.createElement('input');
          endTime.type = 'time';
          endTime.className = 'slot-input';
          endTime.value = slot.end;
          endTime.disabled = true;

          timeRow.appendChild(startTime);
          timeRow.appendChild(sep);
          timeRow.appendChild(endTime);

          const spotsLabel = document.createElement('div');
          spotsLabel.className = 'slot-label';
          spotsLabel.textContent = 'Positions';

          const spotsInput = document.createElement('input');
          spotsInput.type = 'number';
          spotsInput.className = 'slot-input';
          spotsInput.value = slot.positions;
          spotsInput.disabled = true;

          const actions = document.createElement('div');
          actions.className = 'slot-actions';

          const status = document.createElement('div');
          status.className = 'slot-status';
          status.textContent = slot.confirmed ? 'Confirmed' : 'Needs confirmation';

          actions.appendChild(status);

          card.appendChild(badge);
          card.appendChild(deleteBtn);
          card.appendChild(timeLabel);
          card.appendChild(timeRow);
          card.appendChild(spotsLabel);
          card.appendChild(spotsInput);
          card.appendChild(actions);

          list.appendChild(card);
        });

        group.appendChild(title);
        group.appendChild(list);
        bookingSummary.appendChild(group);
      });
    };

    const renderSlots = () => {
      if (!modalSlotList) return;
      modalSlotList.innerHTML = '';

      const court = getActiveCourt();
      if (!court) return;

      if (modalSkip) {
        modalSkip.style.display = court.slots.length ? 'none' : 'inline-flex';
      }
      if (modalConfirmSlots) {
        modalConfirmSlots.style.display = court.slots.length ? 'inline-flex' : 'none';
      }

      if (!court.slots.length) {
        const empty = document.createElement('div');
        empty.className = 'panel-empty';
        empty.textContent = 'No slots yet. Add a slot to get started.';
        modalSlotList.appendChild(empty);
        return;
      }

      court.slots.forEach((slot, index) => {
        const card = document.createElement('div');
        card.className = 'slot-card';

        const badge = document.createElement('div');
        badge.className = 'slot-badge';
        badge.textContent = String(index + 1);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'slot-delete';
        deleteBtn.setAttribute('aria-label', 'Remove slot');
        deleteBtn.textContent = '×';
        deleteBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          court.slots.splice(index, 1);
          renderSlots();
          renderCourts();
          renderSlotFilterChips();
          renderSummary();
        });

        const timeLabel = document.createElement('div');
        timeLabel.className = 'slot-label';
        timeLabel.textContent = 'Time';

        const timeRow = document.createElement('div');
        timeRow.className = 'slot-row';

        const startTime = document.createElement('input');
        startTime.type = 'time';
        startTime.className = 'slot-input';
        startTime.value = slot.start;
        startTime.addEventListener('click', () => {
          if (typeof startTime.showPicker === 'function') {
            startTime.showPicker();
          }
        });
        startTime.addEventListener('input', (event) => {
          slot.start = event.target.value;
          slot.overlapConfirmed = false;
          card.classList.remove('is-warning');
          if (!slot.confirmed) {
            status.textContent = 'Needs confirmation';
            confirmBtn.textContent = 'Confirm';
          }
          renderSummary();
        });

        const sep = document.createElement('span');
        sep.className = 'slot-sep';
        sep.textContent = 'to';

        const endTime = document.createElement('input');
        endTime.type = 'time';
        endTime.className = 'slot-input';
        endTime.value = slot.end;
        endTime.addEventListener('click', () => {
          if (typeof endTime.showPicker === 'function') {
            endTime.showPicker();
          }
        });
        endTime.addEventListener('input', (event) => {
          slot.end = event.target.value;
          slot.overlapConfirmed = false;
          card.classList.remove('is-warning');
          if (!slot.confirmed) {
            status.textContent = 'Needs confirmation';
            confirmBtn.textContent = 'Confirm';
          }
          renderSummary();
        });

        timeRow.appendChild(startTime);
        timeRow.appendChild(sep);
        timeRow.appendChild(endTime);

        const spotsLabel = document.createElement('div');
        spotsLabel.className = 'slot-label';
        spotsLabel.textContent = 'Positions';

        const spotsInput = document.createElement('input');
        spotsInput.type = 'number';
        spotsInput.min = '1';
        spotsInput.className = 'slot-input';
        spotsInput.value = slot.positions;
        spotsInput.addEventListener('input', (event) => {
          slot.positions = event.target.value;
          renderSummary();
        });

        const actions = document.createElement('div');
        actions.className = 'slot-actions';

        const status = document.createElement('div');
        status.className = 'slot-status';

        const confirmBtn = document.createElement('button');
        confirmBtn.type = 'button';
        confirmBtn.className = 'slot-confirm';

        const setConfirmed = (confirmed) => {
          if (!confirmed) {
            slot.confirmed = false;
            slot.overlapConfirmed = false;
            card.classList.remove('is-warning');
            card.classList.remove('is-confirmed');
            confirmBtn.textContent = 'Confirm';
            status.textContent = 'Needs confirmation';
            [startTime, endTime, spotsInput].forEach((input) => {
              input.disabled = false;
            });
            renderSummary();
            return;
          }

          if (!isValidRange(slot)) {
            slot.overlapConfirmed = false;
            card.classList.add('is-warning');
            status.textContent = 'End time must be later than start time.';
            confirmBtn.textContent = 'Confirm';
            return;
          }

          if (slot.isNew) {
            const overlapSlot = getOverlapSlot(slot, court);
            if (overlapSlot && !slot.overlapConfirmed) {
              slot.overlapConfirmed = true;
              card.classList.add('is-warning');
              status.textContent = `Overlaps ${overlapSlot.start} to ${overlapSlot.end}. Confirm again to add anyway.`;
              confirmBtn.textContent = 'Confirm anyway';
              return;
            }
          }

          slot.overlapConfirmed = false;
          slot.isNew = false;
          slot.confirmed = true;
          card.classList.remove('is-warning');
          card.classList.add('is-confirmed');
          confirmBtn.textContent = 'Edit';
          status.textContent = 'Confirmed';
          [startTime, endTime, spotsInput].forEach((input) => {
            input.disabled = true;
          });
          renderSummary();
          void saveSlotToApi(court.id, slot);
        };

        confirmBtn.addEventListener('click', () => {
          setConfirmed(!slot.confirmed);
        });

        actions.appendChild(status);
        actions.appendChild(confirmBtn);

        card.appendChild(badge);
        card.appendChild(deleteBtn);
        card.appendChild(timeLabel);
        card.appendChild(timeRow);
        card.appendChild(spotsLabel);
        card.appendChild(spotsInput);
        card.appendChild(actions);

        modalSlotList.appendChild(card);

        setConfirmed(Boolean(slot.confirmed));
      });
    };

    addCourtBtn?.addEventListener('click', () => {
      const newCourt = createCourt();
      courts.push(newCourt);
      lastCreatedCourtId = newCourt.id;
      renderCourts();
      renderSlotFilterChips();
      renderSummary();
      openModal(newCourt.id);
      void saveCourtToApi(newCourt);
    });

    modalAddSlot?.addEventListener('click', () => {
      const court = getActiveCourt();
      if (!court) return;
      const slot = createSlot();
      court.slots.push(slot);
      renderSlots();
      renderCourts();
      renderSlotFilterChips();
      renderSummary();
      void saveSlotToApi(court.id, slot);
    });

    modalContinue?.addEventListener('click', confirmCourtName);
    modalCourtName?.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        confirmCourtName();
      }
    });

    slotFilterToggle?.addEventListener('click', () => {
      if (!slotFilterSurface) return;
      const open = slotFilterSurface.classList.toggle('open');
      slotFilterToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    });

    modalClose?.addEventListener('click', closeModal);
    modalSkip?.addEventListener('click', closeModal);
    modalConfirmSlots?.addEventListener('click', closeModal);
    slotModal?.addEventListener('click', (event) => {
      if (event.target === slotModal) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && slotModal?.classList.contains('open')) {
        closeModal();
      }
    });

    const init = async () => {
      const remoteCourts = await fetchCourtsFromApi();
      if (Array.isArray(remoteCourts) && remoteCourts.length) {
        courts = normalizeCourts(remoteCourts);
        courtCount = Math.max(...courts.map((court) => court.id));
      } else {
        courts = [];
        courtCount = 0;
      }
      renderCourts();
      renderSlotFilterChips();
      renderSummary();
    };

    void init();
  </script>
</body>
</html>
